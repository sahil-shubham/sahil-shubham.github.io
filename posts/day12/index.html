<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta content="chrome=1" http-equiv="X-UA-Compatible"/>
        <meta content="True" name="HandheldFriendly"/>
        <meta content="320" name="MobileOptimized"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <meta content="no-referrer" name="referrer"/>
        
            <link href='&#x2F;favicons&#x2F;site.webmanifest' rel="manifest"/>
        
        
        
            <link href='&#x2F;favicons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png"/>
        
        
            <link href='&#x2F;favicons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png"/>
        
        
            <link href='&#x2F;favicons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180"/>
        
        <link href="https://sahil-shubham.in/fonts.css" rel="stylesheet"/>
        <link href="https://sahil-shubham.in/style.css" rel="stylesheet"/>
        <title>
            
    Day-12, Things learned after spending time with docker

        </title>
        

        <script async defer data-website-id="9b2dfb9e-f887-4742-8a97-d49a487f5463" src="https://umami.sahil-shubham.in/umami.js"></script>
    </head>
    <body>
        
<div class="wrap">
  <script>
    (function initTheme() {
      let body = document.getElementsByTagName('body')[0];
      if (window.localStorage.getItem('theme') !== null) {
        if (window.localStorage.getItem('theme') === 'dark') {
          body.setAttribute('data-theme', 'dark');
        } else {
          body.setAttribute('data-theme', 'light');
        }
      } else {
        if (
          window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches
        ) {
          body.setAttribute('data-theme', 'dark');
        }
      }
    })();
  </script>
  <div class="section">
    <div class="theme-switcher">
    <div class="theme-button" onClick="toggleTheme()">
        <label for="cb1">
            <svg
                id="dayIcon"
                style="enable-background:new 0 0 35 35;"
                version="1.1"
                viewBox="0 0 35 35"
                x="0px"
                xml:space="preserve"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                xmlns="http://www.w3.org/2000/svg"
                y="0px">
                <g id="Sun">
                    <g>
                        <path
                            d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5 S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z
                                M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5
                                C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6
                                C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9
                                c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44
                                l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5
                                c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06 L6.439,8.561z
                                M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z
                                M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2
                                C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29
                                c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7
                                C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5
                                c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"
                            style="fill-rule:evenodd;clip-rule:evenodd;"/>
                    </g>
                </g>
            </svg>
        </label>
        <input class="toggle" id="cb1" onClick="toggleTheme()" type="checkbox"/>
        <label class="toggle-button" for="cb1"></label>
        <label for="cb1">
            <svg
                enable-background="new 0 0 100 100"
                id="nightIcon"
                version="1.1"
                viewBox="0 0 100 100"
                x="0px"
                xml:space="preserve"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                xmlns="http://www.w3.org/2000/svg"
                y="0px">
                <path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571
                C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23
                c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369
                c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65 c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"/>
            </svg>
        </label>
    </div>
</div>
  </div>
  <div class="section" id="title">
    
    Day-12, Things learned after spending time with docker


  </div>

  <div class="section" id="content">
    
    
        <div class="byline">
            
                
    
    Wednesday 11 Aug, 2021

            
            
                
                    &#183; 748 words
                
            
            
                
                
                    &#183; 4 min
                
            
        </div>
        
        <hr/>
    <h1 id="preface">Preface</h1>
<p>I been spending time learning about docker and trying to dockerize a project. These are some points/tips that I didn't find explained properly in a lot of guides and articles. Got to know most of these from <a href="https://mukul-mehta.in">Mukul Mehta</a> (don't be surprised if you find his blog theme similar to mine, it was the other way around).</p>
<h2 id="expose-isn-t-exposing">EXPOSE isn't exposing</h2>
<p>One thing that I realized after reading a few articles was how much people mix up the EXPOSE instruction. Some writers tend to overuse the word expose which makes beginners feel as if just writing <code>EXPOSE 80</code> &quot;exposes&quot; the port, which makes someone think that they can now connect to port 80 of the container from outside. But it doesn't.</p>
<p>EXPOSE is mainly a way of documenting in a dockerfile. The better term would be &quot;publishing&quot; a port. The <code>-p</code> flag added while running a container is to publish or bind an exposed port to any port of the host machine. Most of the times, while running a container we tend to &quot;map&quot; the published ports to a specific port.</p>
<pre data-lang="bash" style="background-color:#2b2c2f;color:#cccece;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#6699cc;">docker run</span><span style="color:#5fb3b3;"> -</span><span style="color:#f99157;">p</span><span style="color:#6699cc;"> 8000:80 </span><span style="color:#5fb3b3;">&lt;</span><span style="color:#6699cc;">image_name</span><span style="color:#5fb3b3;">&gt;
</span></code></pre>
<p>Running this command publishes port 80 of the container and maps it to port 8000 of the host machine.</p>
<h2 id="docker-buildkit">DOCKER BUILDKIT</h2>
<p>Building images takes time. A lot of time.</p>
<p><img src="https://sahil-shubham.in/posts/day12/docker_wait.jpg" alt="docker_wait" /></p>
<p><a href="https://github.com/moby/buildkit">Docker Buildkit</a> has been a recent addition (<a href="https://blog.mobyproject.org/introducing-buildkit-17e056cc5317">2017 blog introducing it</a>) and is something which can be used to reduce the build times.</p>
<p>They mention the following as their key features on their repository:</p>
<ul>
<li>Automatic garbage collection</li>
<li>Extendable frontend formats</li>
<li>Concurrent dependency resolution</li>
<li>Efficient instruction caching</li>
<li>Build cache import/export</li>
<li>Nested build job invocations</li>
<li>Distributable workers</li>
<li>Multiple output formats</li>
<li>Pluggable architecture</li>
<li>Execution without root privileges</li>
</ul>
<p>You can use it by adding <code>DOCKER_BUILDKIT=1</code> in your docker build command. I didn't find any articles checking how much time it saves due the features mentioned above, hence I would it myself someday.</p>
<h2 id="get-good-at-organizing-layers">Get good at organizing layers</h2>
<p>The key to writing good dockerfiles is to position intructions with frequent changes as low as possible. What this means if I have the following dockerfile:</p>
<pre data-lang="Dockerfile" style="background-color:#2b2c2f;color:#cccece;" class="language-Dockerfile "><code class="language-Dockerfile" data-lang="Dockerfile"><span>  FROM node:14
</span><span>  WORKDIR /project
</span><span>
</span><span>  COPY package.json .
</span><span>  COPY yarn.lock .
</span><span>
</span><span>  RUN yarn install
</span><span>  RUN yarn build-app
</span><span>
</span><span>  COPY docker/start.sh .
</span><span>  RUN chmod +x start.sh
</span><span>  EXPOSE 80
</span><span>  ENTRYPOINT [ &quot;./start.sh&quot; ]
</span></code></pre>
<p>And I make any changes to the <code>start.sh</code> script and make a build again, docker uses the cache from previos build and rather than going through the whole process of installing all the packages it starts from <code>COPY docker/start.sh</code>. The opposite would have happened if I had copied the script above <code>RUN yarn install</code>.</p>
<p>Docker layers are stacked on top of each other and they are all read-only, with the exception of the topmost, writable layer. Each instruction is a separate layer, hence it's good to combine commands using something like <code>&amp;&amp;</code> or putting them inside a script and running that instead. The layers for the above dockerfile can be represented like this:</p>
<p><img src="https://sahil-shubham.in/posts/day12/layers.png" alt="Dockerfile layers" /></p>
<p>Making a change in any layer would make docker build start from that layer to the top.</p>
<h2 id="tip-no-need-to-write-the-complete-image-id">[TIP] No need to write the complete image id</h2>
<p>Stopping a container would be done very frequently while development. To see what containers are running you run:</p>
<pre data-lang="bash" style="background-color:#2b2c2f;color:#cccece;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#6699cc;">docker ps
</span></code></pre>
<p>This prints out an output similar to below:</p>
<pre data-lang="bash" style="background-color:#2b2c2f;color:#cccece;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#6699cc;">CONTAINER ID   IMAGE          COMMAND        CREATED       STATUS       PORTS                  NAMES
</span><span style="color:#6699cc;">22528c8e2d2b   neera:latest   </span><span style="color:#5fb3b3;">&quot;</span><span style="color:#99c794;">./start.sh</span><span style="color:#5fb3b3;">&quot;</span><span style="color:#6699cc;">   2 hours ago   Up 2 hours   0.0.0.0:8000-</span><span style="color:#5fb3b3;">&gt;</span><span style="color:#f99157;">80</span><span style="color:#6699cc;">/tcp   laughing_williams
</span></code></pre>
<p>After which I used to copy the container id and paste it in the command:</p>
<pre data-lang="bash" style="background-color:#2b2c2f;color:#cccece;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#6699cc;">docker stop </span><span style="color:#5fb3b3;">&lt;</span><span style="color:#6699cc;">container_id</span><span style="color:#5fb3b3;">&gt;
</span></code></pre>
<p>Turns out if there aren't anything with similar id all one can do is write the first 1-2 letters of the id in docker stop and it does the same thing.</p>
<p>Hence, writing <code>docker stop 22528c8e2d2b</code> and <code>docker stop 22</code> does the same thing, till there are no other containers starting with 22. Can't believe I am saying this but</p>
<pre data-lang="txt" style="background-color:#2b2c2f;color:#cccece;" class="language-txt "><code class="language-txt" data-lang="txt"><span>  Life is too short to write full container ids
</span></code></pre>
<h2 id="refrences-interesting-reads">Refrences/Interesting Reads</h2>
<ul>
<li><a href="https://www.learncloudnative.com/blog/2020-04-29-beginners-guide-to-docker?utm_source=pocket_mylist">Beginners guide to Docker</a></li>
<li><a href="https://stackoverflow.com/questions/30137135/confused-about-docker-t-option-to-allocate-a-pseudo-tty?utm_source=pocket_mylist">Docker -t flag / pseduo-TTY</a></li>
<li><a href="https://github.com/moby/moby/blob/master/pkg/namesgenerator/names-generator.go">Container names generator function</a></li>
<li><a href="https://jvns.ca/blog/2016/10/10/what-even-is-a-container/?utm_source=pocket_mylist">What even is a container</a></li>
</ul>

    
    <div class="social-icons">
        
            <a class="social-icons__link" href=mailto:hello@sahil-shubham.in rel="noopener" target="_blank">
                <svg
                    class="feather feather-mail"
                    class="scicon"
                    fill="none"
                    height="24"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
            </a>
        
        
            <a class="social-icons__link" href=https:&#x2F;&#x2F;github.com&#x2F;sahil-shubham rel="noopener" target="_blank">
                <svg
                    class="featherfeather-github"
                    class="scicon"
                    fill="none"
                    height="24"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    stroke="currentColor"
                    viewBox="002424"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7
                        0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                </svg>
            </a>
        
        
            <a class="social-icons__link" href=https:&#x2F;&#x2F;twitter.com&#x2F;sahil_shubham_ rel="noopener" target="_blank">
                <svg
                    class="feather feather-twitter"
                    class="scicon"
                    fill="none"
                    height="24"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
                </svg>
            </a>
        
        
            <a class="social-icons__link" href=https:&#x2F;&#x2F;sahil-shubham.in&#x2F;atom.xml rel="noopener" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
            </a>
        
        
    </div>

    
        <h1>Comments</h1>
        <script src="https://utteranc.es/client.js"
            repo="sahil-shubham/sahil-shubham.in"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
        </script>
    

  </div>
  <script
    src="https://sahil-shubham.in/main.js"
    type="text/javascript"
  ></script>
  
    <div class="section bottom-menu">
        <hr/>
        <p>
            
                
                    <a href="&#x2F;about">about</a>
                    &#183;
                
                    <a href="&#x2F;posts">posts</a>
                    &#183;
                
                    <a href="&#x2F;resume.pdf">resume</a>
                    &#183;
                
            
            <a href="https:&#x2F;&#x2F;sahil-shubham.in">
                home
            </a>
            &#183;
            <a href="https:&#x2F;&#x2F;github.com&#x2F;sahil-shubham">
                github
            </a>
            &#183;
            <a href="https:&#x2F;&#x2F;twitter.com&#x2F;sahil_shubham_">
                twitter
            </a>
            &#183;
            <a href="https:&#x2F;&#x2F;sahil-shubham.in&#x2F;atom.xml">
                rss
            </a>
        </p>
                   
    </div>

</div>

    </body>
</html>